# 双臂机械臂安全使用指南

## 🚨 重要安全提醒

**在运行任何机械臂代码之前，请务必阅读并遵循以下安全指南！**

## 1. 运行前安全检查清单

### 1.1 环境检查
- [ ] 确认机械臂周围1米范围内无人员
- [ ] 确认机械臂工作空间内无障碍物
- [ ] 检查所有电缆连接是否牢固
- [ ] 确认紧急停止按钮可正常工作
- [ ] 检查CAN总线连接状态

### 1.2 软件检查
- [ ] 确认使用安全版本的测试代码 (`test_dual_arm_safe.py`)
- [ ] 检查工作空间限制设置是否合理
- [ ] 确认运动速度限制设置
- [ ] 验证紧急停止机制

## 2. 安全等级说明

### 2.1 安全等级分类
- **LOW (低风险)**: 低速、小范围运动，适合调试
- **MEDIUM (中等风险)**: 正常操作，适合一般测试
- **HIGH (高风险)**: 高速或复杂运动，需要特别小心

### 2.2 安全参数设置
```python
# 高安全等级设置
max_speed = 0.1 m/s        # 最大速度
max_acceleration = 0.2 m/s² # 最大加速度
control_frequency = 100 Hz  # 控制频率

# 中等安全等级设置
max_speed = 0.3 m/s
max_acceleration = 0.5 m/s²
control_frequency = 100 Hz

# 低安全等级设置
max_speed = 0.5 m/s
max_acceleration = 1.0 m/s²
control_frequency = 100 Hz
```

## 3. 紧急停止机制

### 3.1 多种紧急停止方式
1. **键盘中断**: `Ctrl + C`
2. **用户输入**: 输入 `q` + Enter
3. **系统信号**: `kill` 命令
4. **硬件按钮**: 物理紧急停止按钮

### 3.2 紧急停止后的处理
```python
# 检查紧急停止状态
if controller.safety_monitor.check_emergency_stop():
    print("紧急停止激活!")
    # 停止所有运动
    # 检查机械臂状态
    # 必要时手动回零
```

## 4. 工作空间安全限制

### 4.1 默认安全限制
```python
workspace_limits = {
    'x': (-0.8, 0.8),    # 前后方向 (米)
    'y': (-0.8, 0.8),    # 左右方向 (米)
    'z': (-0.2, 0.8),    # 上下方向 (米)
}

# 额外限制
min_height = 0.05 m      # 最低高度
max_reach = 0.7 m        # 最大伸展距离
```

### 4.2 自定义安全限制
根据你的具体环境调整限制：
```python
# 更保守的限制
workspace_limits = {
    'x': (-0.5, 0.5),
    'y': (-0.5, 0.5),
    'z': (0.1, 0.6),
}
```

## 5. 运动安全监控

### 5.1 实时监控项目
- 位置是否在安全范围内
- 运动速度是否超限
- 加速度是否合理
- 四元数是否有效
- 通信是否正常

### 5.2 异常处理
```python
# 监控运动安全性
if not safety_monitor.monitor_motion_safety(dual_arm):
    print("安全监控失败，停止运动!")
    # 执行紧急停止
```

## 6. 最佳实践

### 6.1 代码使用建议
1. **始终使用安全版本**: 使用 `test_dual_arm_safe.py` 而不是原始版本
2. **从低安全等级开始**: 首次运行时使用 `SafetyLevel.HIGH`
3. **小步测试**: 先测试小范围运动，再逐步扩大
4. **保持监控**: 运行期间始终保持监控状态

### 6.2 测试流程建议
```python
# 1. 初始化并回零
controller = SafeDualArmController(left_config, right_config)
controller.go_home_safe()

# 2. 小范围测试
target_poses = {
    "left": (np.array([0.1, 0.0, 0.1]), np.array([1.0, 0.0, 0.0, 0.0])),
    "right": (np.array([0.1, 0.0, 0.1]), np.array([1.0, 0.0, 0.0, 0.0])),
}

# 3. 高安全等级运动
success = controller.set_ee_pose_safe(
    target_poses, 
    duration=5.0,  # 慢速运动
    safety_level=SafetyLevel.HIGH
)
```

### 6.3 故障排除
1. **CAN通信失败**: 检查CAN端口和权限
2. **位置超限**: 调整目标位置或工作空间限制
3. **速度过快**: 增加运动时间或降低安全等级
4. **四元数错误**: 检查姿态设置

## 7. 危险操作警告

### 7.1 绝对禁止的操作
- ❌ 在人员附近运行高速运动
- ❌ 超出工作空间限制的运动
- ❌ 关闭安全监控
- ❌ 使用过高的运动速度
- ❌ 在不确定的环境中使用

### 7.2 需要特别小心的操作
- ⚠️ 首次运行新代码
- ⚠️ 修改安全参数
- ⚠️ 在复杂环境中运动
- ⚠️ 长时间无人监控运行

## 8. 紧急情况处理

### 8.1 如果机械臂失控
1. 立即按 `Ctrl + C`
2. 输入 `q` + Enter
3. 使用物理紧急停止按钮
4. 断开电源（最后手段）

### 8.2 如果代码卡死
1. 打开新终端
2. 使用 `ps aux | grep python` 查找进程
3. 使用 `kill -9 <PID>` 强制终止
4. 检查机械臂状态

## 9. 联系和支持

如果遇到安全问题或需要帮助：
1. 检查日志输出
2. 查看错误信息
3. 参考本文档的故障排除部分
4. 联系技术支持

---

**记住：安全永远是第一位的！宁可保守也不要冒险。**
