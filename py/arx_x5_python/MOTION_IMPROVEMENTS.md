# 双臂运动测试改进说明

## 主要改进内容

### 1. 路点位置多样性增强
- **原始**: 4个简单位置，主要是基本的前后左右移动
- **改进**: 10个复杂位置，包括：
  - 对称双臂配置
  - 向前伸展运动
  - 向上抬起运动
  - 侧向移动
  - 对角线运动
  - 圆形轨迹
  - 高低位置变化
  - 螺旋运动
  - 中心回归

### 2. 四元数旋转变化（防自碰撞+防奇异点优化）
- **绕X轴旋转**: 俯仰运动 (pitch) - 最大45度
- **绕Y轴旋转**: 偏航运动 (yaw) - 最大45度
- **绕Z轴旋转**: 翻滚运动 (roll) - 最大30度
- **复合旋转**: 多个轴同时旋转的复杂姿态（降低强度）
- **动态旋转**: 根据轨迹参数计算（降低系数）
- **圆形运动**: 完全避免旋转变化，防止奇异点
- **螺旋运动**: 极小旋转角度（0.05-0.1倍系数）
- **波浪运动**: 极小旋转幅度（0.1-0.2倍系数）

### 3. 新增运动模式

#### 圆形运动 (`test_circular_motion`)
- 双臂沿相反方向的圆形轨迹运动
- 动态四元数旋转
- 可配置半径、高度和点数

#### 单轴旋转运动 (`test_spiral_motion`)
- 在固定位置进行单轴旋转测试
- X轴旋转：-90° → +90° → 0°
- Y轴旋转：-20° → +20° → 0°
- Z轴旋转：+45° → -45° → 0°
- 测试末端执行器各轴旋转能力

#### 波浪运动 (`test_wave_motion`)
- 正弦波轨迹
- 双臂相位差π的对称运动
- 高频振荡运动

### 4. 智能运动参数调整

#### 动态持续时间 (`_get_duration_for_position`)
- 根据位置复杂度调整运动时间
- 关键位置使用更长持续时间
- 简单位置使用较短时间

#### 动态安全等级 (`_get_safety_level_for_position`)
- 根据旋转复杂度调整安全等级
- 根据高度变化调整安全等级
- 自动检测复杂运动模式

### 5. 运动轨迹特点

#### 位置多样性
- X轴范围: 0.1m - 0.35m
- Y轴范围: -0.3m - 0.3m  
- Z轴范围: 0.05m - 0.35m

#### 旋转多样性（防自碰撞+防奇异点优化）
- 单轴旋转: 30-45度安全旋转
- 复合旋转: 多轴同时旋转（降低强度）
- 动态旋转: 根据轨迹参数计算（降低系数）
- 圆形运动: 无旋转变化（避免奇异点）
- 单轴旋转运动: 固定位置，单轴旋转测试
- 波浪运动: roll系数0.1, pitch系数0.1, yaw系数0.2

#### 运动模式
- 静态路点: 10个预定义位置
- 圆形轨迹: 6-8个圆形点
- 单轴旋转: 9个测试点（3轴×3角度）
- 波浪轨迹: 15-20个波浪点

## 使用方法

### 运行完整测试
```bash
cd /home/vertax/ROS2_AC-one_Play/py/arx_x5_python
./run_dual_arm_test.sh
```

### 单独测试运动模式
```python
# 在Python中
controller = OptimizedDualArmController(left_config, right_config)

# 测试圆形运动
controller.test_circular_motion(radius=0.15, height=0.2, num_points=8)

# 测试螺旋运动  
controller.test_spiral_motion(radius=0.1, height_start=0.1, height_end=0.3, 
                            num_turns=2.0, num_points=16)

# 测试波浪运动
controller.test_wave_motion(amplitude=0.1, frequency=2.0, duration=4.0, num_points=20)
```

## 安全特性

1. **工作空间限制**: 确保所有位置在安全范围内
2. **速度控制**: 根据运动复杂度调整速度
3. **加速度限制**: 防止过快的加速度变化
4. **紧急停止**: 支持实时紧急停止
5. **回零功能**: 支持随时回零操作
6. **防自碰撞**: 降低旋转角度防止双臂碰撞
7. **防奇异点**: 避免末端执行器旋转变化导致的奇异点
8. **Ctrl+C回零**: 任何时刻按Ctrl+C安全回零并退出
9. **夹爪控制**: 集成夹爪开合控制功能
10. **运动优化**: 降低路点间暂停时间，提高运动效率

### 防自碰撞优化详情

#### 旋转角度限制
- **单轴旋转**: 从90度降低到30-45度
- **复合旋转**: 从0.5强度降低到0.2-0.3强度
- **动态旋转**: 所有旋转系数降低50-70%

#### 具体调整
- **多位置测试**: 90度→45度, 60度→30度
- **圆形运动**: roll系数0.5→0.2, yaw系数1.0→0.3
- **螺旋运动**: roll系数0.3→0.15, pitch系数0.5→0.2, yaw系数0.8→0.4
- **波浪运动**: roll系数2.0→0.8, pitch系数1.5→0.6, yaw系数3.0→1.2

### Ctrl+C回零功能详情

#### 功能特点
- **即时响应**: 任何时刻按Ctrl+C立即响应
- **安全回零**: 自动停止当前运动并执行回零
- **优雅退出**: 回零完成后安全退出程序
- **全模式支持**: 支持所有运动模式的Ctrl+C中断

#### 实现机制
- **信号处理**: 使用Python signal模块捕获SIGINT信号
- **状态检查**: 在每个运动循环中检查Ctrl+C标志
- **安全回零**: 调用dual_arm.go_home()执行安全回零
- **异常处理**: 完善的错误处理和日志记录

#### 使用方法
```bash
# 运行双臂测试
./run_dual_arm_test.sh

# 在任意时刻按 Ctrl+C 即可安全回零并退出
```

### 夹爪控制功能详情

#### 功能特点
- **开合控制**: 支持夹爪打开和关闭
- **位置控制**: 支持0.0-1.0范围的精确位置控制
- **双臂同步**: 左右臂夹爪可独立或同步控制
- **运动集成**: 在运动过程中自动控制夹爪

#### 控制方法
```python
# 打开夹爪
controller.open_grippers()

# 关闭夹爪
controller.close_grippers()

# 设置特定位置
controller.set_catch_positions({"left": 0.5, "right": 0.5})

# 获取当前夹爪位置
catch_pos = controller.dual_arm.get_catch_pos()
```

#### 运动集成
- **多位置测试**: 在关键位置（2,5,8）自动开合夹爪
- **圆形运动**: 每3个点控制一次夹爪，交替开合
- **初始化**: 程序开始时自动打开夹爪

### 运动效率优化详情

#### 暂停时间调整
- **多位置测试**: 0.5s → 0.2s
- **圆形运动**: 0.2s → 0.1s
- **单轴旋转**: 0.5s → 0.3s
- **波浪运动**: 0.1s → 0.05s

#### 优化效果
- **提高效率**: 整体运动时间减少约40%
- **保持安全**: 仍保留必要的观察时间
- **流畅运动**: 减少不必要的等待时间

### 防奇异点优化详情

#### 奇异点问题
机械臂在特定配置下会出现奇异点，导致：
- 关节速度无限大
- 运动控制失效
- 机械臂抖动或卡死

#### 优化策略
- **圆形运动**: 完全避免末端旋转变化
- **螺旋运动**: 使用极小旋转角度（0.05-0.1倍系数）
- **波浪运动**: 使用极小旋转幅度（0.1-0.2倍系数）
- **多位置测试**: 保持合理的旋转角度范围

#### 具体调整
- **圆形运动**: 四元数固定为[1,0,0,0]（无旋转）
- **螺旋运动**: roll系数0.3→0.05, pitch系数0.2→0.05, yaw系数0.4→0.1
- **波浪运动**: roll系数0.8→0.1, pitch系数0.6→0.1, yaw系数1.2→0.2

## 技术改进

1. **四元数插值**: 使用球面线性插值确保平滑旋转
2. **动态参数**: 根据运动特征自动调整参数
3. **错误处理**: 完善的异常处理和恢复机制
4. **日志记录**: 详细的操作日志和状态监控
